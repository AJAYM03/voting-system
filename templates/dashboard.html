{% extends "base.html" %}
{% block content %}
<h2>Dashboard</h2>

{% if role == 'admin' %}
    <h4>Election Statistics</h4>
    {% for election_title, candidates in statistics.items() %}
        <h5>{{ election_title }}</h5>
        <a href="{{ url_for('download_statistics', election_title=election_title) }}" class="btn btn-secondary">Download PDF</a> <!-- Moved here -->
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">Candidate Name</th>
                    <th scope="col">Total Votes</th>
                </tr>
            </thead>
            <tbody>
                {% if candidates %}
                    {% for candidate in candidates %}
                        <tr>
                            <td>{{ candidate.candidate_name }}</td>
                            <td>{{ candidate.total_votes }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="2">No candidates for this election.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    {% endfor %}
    <a href="{{ url_for('download_all_statistics') }}" class="btn btn-primary">Download All Statistics PDF</a>

    <h4>Create New Election</h4>
    <form action="/admin/create_election" method="POST">
        <div class="form-group">
            <label for="election_name">Election Name:</label>
            <input type="text" name="name" id="election_name" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="election_date">Election Date:</label>
            <input type="date" name="date" id="election_date" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Create Election</button>
    </form>

{% elif role == 'candidate' %}
    <h4>Register as Candidate</h4>
    <form action="/candidate/register" method="POST">
        <div class="form-group">
            <label for="election_id">Select Election:</label>
            <select name="election_id" id="election_id" class="form-control">
                {% for election in elections %}
                    <option value="{{ election[0] }}">{{ election[1] }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Register</button>
    </form>

{% elif role == 'voter' %}
    <h4>Select Election to Vote</h4>
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Election ID</th>
                <th scope="col">Election Title</th>
                <th scope="col">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for election in elections %}
                <tr>
                    <td>{{ election[0] }}</td>
                    <td>{{ election[1] }}</td>
                    <td>
                        <button class="btn btn-primary" onclick="loadCandidates({{ election[0] }})">Select</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <div id="candidates-section" style="display: none;">
        <h4>Candidates for Election <span id="election-title"></span></h4>
        <table class="table" id="candidates-table">
            <thead>
                <tr>
                    <th scope="col">Candidate ID</th>
                    <th scope="col">Candidate Name</th>
                    <th scope="col">Action</th>
                </tr>
            </thead>
            <tbody id="candidates-body"></tbody>
        </table>
    </div>

    <form id="vote-form" action="/vote" method="POST" style="display: none;">
        <input type="hidden" id="election_id" name="election_id">
        <input type="hidden" id="candidate_id" name="candidate_id">
        <button type="submit" class="btn btn-success">Cast Vote</button>
    </form>

    <script>
        function loadCandidates(electionId) {
            document.getElementById("election_id").value = electionId;
            const candidatesBody = document.getElementById("candidates-body");
            candidatesBody.innerHTML = '';

            fetch(`/candidates/${electionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.candidates.length > 0) {
                        document.getElementById("election-title").textContent = data.election_title;
                        document.getElementById("candidates-section").style.display = 'block';

                        data.candidates.forEach(candidate => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td>${candidate.id}</td>
                                <td>${candidate.name}</td>
                                <td><button class="btn btn-secondary" onclick="vote('${candidate.id}')">Vote</button></td>
                            `;
                            candidatesBody.appendChild(row);
                        });
                    } else {
                        alert("No candidates available for this election.");
                    }
                })
                .catch(error => console.error('Error fetching candidates:', error));
        }

        function vote(candidateId) {
            document.getElementById("candidate_id").value = candidateId;
            document.getElementById("vote-form").style.display = 'block';
        }
    </script>

{% endif %}
{% endblock %}
